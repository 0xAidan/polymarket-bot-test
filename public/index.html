<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CopyTrade95 - Polymarket Bot</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="desktop">
    <!-- Main Window -->
    <div class="win-window" id="mainWindow">
      <!-- Title Bar -->
      <div class="win-titlebar">
        <div class="win-titlebar-icon">&#128200;</div>
        <div class="win-titlebar-text">CopyTrade95 - Polymarket Copy Trading Bot</div>
        <div class="win-titlebar-buttons">
          <button class="win-titlebar-btn" title="Minimize">_</button>
          <button class="win-titlebar-btn" title="Maximize">&#9633;</button>
          <button class="win-titlebar-btn" title="Close">X</button>
        </div>
      </div>

      <!-- Menu Bar -->
      <div class="win-menubar">
        <button class="win-menu-item" id="menuBot" onclick="toggleBotMenu()">Bot</button>
        <button class="win-menu-item" id="menuView">View</button>
        <button class="win-menu-item" id="menuHelp">Help</button>
      </div>

      <!-- Tab Navigation -->
      <div style="padding: 8px 8px 0;">
        <div class="win-tabs">
          <button class="win-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
          <button class="win-tab" data-tab="wallets" onclick="switchTab('wallets')">Tracked Wallets</button>
          <button class="win-tab" data-tab="trading-wallets" onclick="switchTab('trading-wallets')">Trading Wallets</button>
          <button class="win-tab" data-tab="platforms" onclick="switchTab('platforms')">Platforms</button>
          <button class="win-tab" data-tab="cross-platform" onclick="switchTab('cross-platform')">Cross-Platform</button>
          <button class="win-tab" data-tab="settings" onclick="switchTab('settings')">Settings</button>
          <button class="win-tab" data-tab="diagnostics" onclick="switchTab('diagnostics')">Diagnostics</button>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="win-body">
        <!-- ============================================================
             DASHBOARD TAB
             ============================================================ -->
        <div id="tab-dashboard" class="win-tab-panel active">
          <!-- Wallet Info Bar -->
          <div class="wallet-info-bar">
            <div>
              <div class="text-sm text-muted">Trading Wallet</div>
              <div class="address" id="walletAddress">Not configured</div>
            </div>
            <div style="text-align: right;">
              <div class="balance" id="walletBalance">$0.00</div>
              <div class="balance-change positive" id="balanceChange">+$0.00 (24h)</div>
            </div>
          </div>

          <!-- Metrics Row -->
          <div class="metrics-row">
            <div class="metric-box">
              <div class="metric-value" id="successRate">0%</div>
              <div class="metric-label">Success Rate</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="totalTrades">0</div>
              <div class="metric-label">Total Trades</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="avgLatency">0ms</div>
              <div class="metric-label">Avg Latency</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="walletsTracked">0</div>
              <div class="metric-label">Wallets</div>
            </div>
            <div class="metric-box success">
              <div class="metric-value" id="successfulTrades">0</div>
              <div class="metric-label">Successful</div>
            </div>
            <div class="metric-box danger">
              <div class="metric-value" id="failedTrades">0</div>
              <div class="metric-label">Failed</div>
            </div>
          </div>

          <!-- Recent Trades -->
          <div class="win-group">
            <div class="win-group-title">Recent Trades</div>
            <div style="overflow-x: auto;">
              <table class="win-listview" id="tradesTable">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Wallet</th>
                    <th>Market</th>
                    <th>Side</th>
                    <th>Amount</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="tradesTableBody">
                  <tr class="empty-row"><td colspan="6">No trades yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Active Issues -->
          <div class="win-group hidden" id="issuesCard">
            <div class="win-group-title">Active Issues</div>
            <div id="issuesList"></div>
          </div>

          <!-- Ladder Exits -->
          <div class="win-group">
            <div class="win-group-title">Ladder Exits (Take-Profit)</div>
            <div class="flex-between mb-8">
              <div>
                <span class="text-sm text-muted">Price Monitor:</span>
                <span id="ladderPriceMonitorStatus" class="win-badge">OFF</span>
                <span class="text-sm text-muted" style="margin-left:8px;">Mode:</span>
                <span id="ladderModeStatus" class="win-badge">PAPER</span>
              </div>
              <div class="flex-row gap-4">
                <button class="win-btn win-btn-sm" onclick="toggleLadderLiveMode()">Toggle Live</button>
                <button class="win-btn win-btn-sm" onclick="openCreateLadderForm()">+ New Ladder</button>
              </div>
            </div>

            <!-- Position Picker for Ladder Creation (hidden by default) -->
            <div id="createLadderForm" class="hidden" style="background:var(--win-surface);border:1px solid var(--win-dark);padding:8px;margin-bottom:8px;">
              <div class="flex-between mb-4">
                <div class="text-bold">Select Position for Ladder Exit</div>
                <button class="win-btn win-btn-sm" onclick="closeCreateLadderForm()" aria-label="Close ladder creation form" tabindex="0">Close</button>
              </div>
              <div class="flex-row gap-8 mb-4" style="align-items:center;">
                <label class="text-sm">Trading Wallet:</label>
                <select id="ladderWalletSelect" class="win-input" style="width:250px;" onchange="loadWalletPositionsForLadder()" aria-label="Select trading wallet">
                  <option value="">-- Select a wallet --</option>
                </select>
                <button class="win-btn win-btn-sm" onclick="loadWalletPositionsForLadder()" aria-label="Refresh positions" tabindex="0">Refresh</button>
              </div>
              <div id="ladderPositionsList" style="max-height:400px;overflow-y:auto;">
                <div class="text-center text-muted" style="padding:12px;">Select a trading wallet to see your positions</div>
              </div>

              <!-- Ladder Config Panel (shown when user clicks Add Ladder on a position) -->
              <div id="ladderConfigPanel" class="hidden" style="background:var(--win-highlight);border:1px solid var(--win-dark);padding:8px;margin-top:8px;">
                <div class="text-bold mb-4">Configure Ladder Steps</div>
                <div class="text-sm mb-4" id="ladderConfigPositionSummary"></div>
                <div class="flex-row gap-8 flex-wrap mb-4">
                  <div>
                    <label class="text-sm">Steps</label>
                    <input type="number" id="ladderStepCount" class="win-input" value="4" min="2" max="10" style="width:70px;" aria-label="Number of ladder steps">
                  </div>
                  <div>
                    <label class="text-sm">Start %</label>
                    <input type="number" id="ladderStartPercent" class="win-input" value="10" min="1" max="100" style="width:70px;" aria-label="Start profit percent for first step">
                  </div>
                  <div>
                    <label class="text-sm">Step Spread %</label>
                    <input type="number" id="ladderStepSpread" class="win-input" value="10" min="1" max="100" style="width:70px;" aria-label="Percent spread between steps">
                  </div>
                  <div>
                    <label class="text-sm">Sell % per step</label>
                    <input type="number" id="ladderSellPercent" class="win-input" value="25" min="5" max="100" style="width:70px;" aria-label="Percent of remaining to sell at each step">
                  </div>
                </div>
                <div class="flex-row gap-4">
                  <button class="win-btn win-btn-primary win-btn-sm" onclick="confirmCreateLadder()" aria-label="Confirm and create ladder" tabindex="0">Create Ladder</button>
                  <button class="win-btn win-btn-sm" onclick="cancelLadderConfig()" aria-label="Cancel ladder configuration" tabindex="0">Cancel</button>
                </div>
              </div>
            </div>

            <!-- Active Ladders -->
            <div id="activeLaddersList">
              <div class="text-center text-muted" style="padding:12px;">No active ladders</div>
            </div>
          </div>
        </div>

        <!-- ============================================================
             TRACKED WALLETS TAB
             ============================================================ -->
        <div id="tab-wallets" class="win-tab-panel">
          <!-- Add Wallet -->
          <div class="win-group">
            <div class="win-group-title">Add Tracked Wallet</div>
            <div class="flex-row gap-8">
              <input type="text" id="newWalletAddress" placeholder="0x..." class="win-input" style="flex:1;">
              <button class="win-btn win-btn-primary" onclick="addWallet()">Add Wallet</button>
            </div>
          </div>

          <!-- Tracked Wallets List -->
          <div class="win-group">
            <div class="win-group-title">Tracked Wallets</div>
            <div id="walletsList">
              <div class="text-center text-muted" style="padding:20px;">No wallets tracked yet</div>
            </div>
          </div>
        </div>

        <!-- ============================================================
             TRADING WALLETS TAB (Multi-Wallet)
             ============================================================ -->
        <div id="tab-trading-wallets" class="win-tab-panel">
          <!-- Unlock Prompt -->
          <div id="unlockSection" class="unlock-prompt">
            <div class="lock-icon">&#128274;</div>

            <!-- ==========================================
                 FIRST-TIME SETUP (no wallets exist yet)
                 ========================================== -->
            <div id="unlockFirstTime" class="hidden">
              <div class="mb-8" style="font-size:18px;"><strong>Create Your Master Password</strong></div>

              <div class="win-warning mb-8" style="max-width:440px;margin-left:auto;margin-right:auto;text-align:left;">
                <span style="font-size:18px;">&#9888;</span>
                <div>
                  <strong>This password cannot be changed or recovered.</strong><br>
                  <span class="text-sm">It encrypts your wallet private keys and API credentials.
                  If you forget it, you will lose access to all stored wallets and need to re-add them.</span>
                </div>
              </div>

              <div class="text-sm text-muted mb-8" style="max-width:400px;margin:0 auto;text-align:left;">
                Choose a strong password you will remember. It is <strong>never stored</strong> anywhere &mdash; only used
                to encrypt/decrypt your data each session.
              </div>

              <div style="max-width:340px;margin:0 auto;">
                <div class="form-row" style="margin-bottom:6px;">
                  <label for="masterPasswordNew" style="min-width:130px;">Password:</label>
                  <input type="password" id="masterPasswordNew" placeholder="Choose a password..." class="win-input" style="flex:1;" aria-label="New master password" autocomplete="new-password">
                </div>
                <div class="form-row" style="margin-bottom:6px;">
                  <label for="masterPasswordConfirm" style="min-width:130px;">Confirm:</label>
                  <input type="password" id="masterPasswordConfirm" placeholder="Type it again..." class="win-input" style="flex:1;" aria-label="Confirm master password" autocomplete="new-password">
                </div>
                <div id="passwordMatchError" class="hidden" style="color:var(--danger);font-size:13px;margin-left:138px;margin-bottom:6px;">
                  Passwords do not match.
                </div>
                <div class="form-row">
                  <label style="min-width:130px;"></label>
                  <button class="win-btn win-btn-primary" onclick="createMasterPassword()" aria-label="Create master password and unlock" tabindex="0">Create Password &amp; Unlock</button>
                </div>
              </div>

              <div class="text-sm text-muted mt-8" style="max-width:400px;margin-left:auto;margin-right:auto;">
                If you have a private key in your <code>.env</code> file, it will be automatically migrated to encrypted storage.
              </div>
            </div>

            <!-- ==========================================
                 RETURNING USER (wallets already exist)
                 ========================================== -->
            <div id="unlockReturning">
              <div class="mb-8"><strong>Wallet Vault Locked</strong></div>
              <div class="text-sm text-muted mb-8">Enter your master password to unlock your encrypted trading wallets</div>

              <div class="flex-row gap-8" style="justify-content:center;">
                <input type="password" id="masterPasswordInput" placeholder="Master password..." class="win-input" style="width:250px;" aria-label="Master password" autocomplete="current-password">
                <button class="win-btn win-btn-primary" onclick="unlockVault()" aria-label="Unlock wallet vault" tabindex="0">Unlock</button>
              </div>
            </div>

            <!-- Help section (always visible) -->
            <details style="margin-top:12px;max-width:400px;margin-left:auto;margin-right:auto;text-align:left;">
              <summary class="text-sm" style="cursor:pointer;color:var(--win-text);">How does the master password work?</summary>
              <div class="text-sm text-muted" style="padding:8px 0;">
                <ul style="margin:0;padding-left:16px;">
                  <li>Your trading wallet private keys and API credentials are encrypted on disk using AES-256-GCM.</li>
                  <li>The master password decrypts them &mdash; it is <strong>never stored</strong> anywhere.</li>
                  <li>When you lock the vault (or the bot restarts), all decrypted data is cleared from memory.</li>
                  <li>You must unlock each time the bot restarts to enable trading wallets.</li>
                  <li><strong>There is no password reset or recovery.</strong> If you forget it, you will need to re-add your wallets.</li>
                </ul>
              </div>
            </details>
          </div>

          <!-- Trading Wallets (shown after unlock) -->
          <div id="tradingWalletsSection" class="hidden">
            <!-- Add Trading Wallet -->
            <div class="win-group">
              <div class="win-group-title">Add Trading Wallet</div>
              <div class="form-row">
                <label>Wallet ID:</label>
                <input type="text" id="newTradingWalletId" placeholder="e.g. arb, test" class="win-input">
              </div>
              <div class="form-row">
                <label>Label:</label>
                <input type="text" id="newTradingWalletLabel" placeholder="e.g. Arbitrage Wallet" class="win-input">
              </div>
              <div class="form-row">
                <label>Private Key:</label>
                <input type="password" id="newTradingWalletKey" placeholder="0x..." class="win-input">
              </div>

              <div style="border-top:1px solid var(--win-border);margin:8px 0;padding-top:8px;">
                <div class="text-sm text-muted mb-4" style="margin-left:110px;">
                  <strong>Polymarket Builder API Credentials</strong> &mdash; Required to place orders.
                  <a href="https://polymarket.com/settings?tab=builder" target="_blank" rel="noopener noreferrer" style="color:var(--win-link);">Get them here</a>
                </div>
                <div class="form-row">
                  <label>API Key:</label>
                  <input type="password" id="newTradingWalletApiKey" placeholder="Your Builder API key" class="win-input" aria-label="Polymarket Builder API Key">
                </div>
                <div class="form-row">
                  <label>API Secret:</label>
                  <input type="password" id="newTradingWalletApiSecret" placeholder="Your Builder API secret" class="win-input" aria-label="Polymarket Builder API Secret">
                </div>
                <div class="form-row">
                  <label>API Passphrase:</label>
                  <input type="password" id="newTradingWalletApiPassphrase" placeholder="Your Builder API passphrase" class="win-input" aria-label="Polymarket Builder API Passphrase">
                </div>
              </div>

              <div class="form-row">
                <label></label>
                <button class="win-btn win-btn-primary" onclick="addNewTradingWallet()">Add Wallet</button>
              </div>
            </div>

            <!-- Wallets List -->
            <div class="win-group">
              <div class="win-group-title">Your Trading Wallets</div>
              <div id="tradingWalletsList" class="trading-wallets-grid">
                <div class="text-center text-muted" style="padding:20px;">No trading wallets configured</div>
              </div>
            </div>

            <!-- Copy Assignments -->
            <div class="win-group">
              <div class="win-group-title">Copy Assignments</div>
              <div class="text-sm text-muted mb-8">Map which tracked wallets copy to which of your trading wallets</div>
              <div id="copyAssignmentsList">
                <div class="text-center text-muted" style="padding:12px;">No copy assignments yet</div>
              </div>
              <div class="flex-row gap-8 mt-8">
                <select id="assignTrackedWallet" class="win-select" style="flex:1;">
                  <option value="">Select tracked wallet...</option>
                </select>
                <select id="assignTradingWallet" class="win-select" style="flex:1;">
                  <option value="">Select trading wallet...</option>
                </select>
                <button class="win-btn win-btn-sm" onclick="addAssignment()">Assign</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ============================================================
             SETTINGS TAB
             ============================================================ -->
        <div id="tab-settings" class="win-tab-panel">
          <!-- Stop-Loss -->
          <div class="win-group">
            <div class="win-group-title">Stop-Loss Protection</div>
            <div class="text-sm text-muted mb-8">Stop taking new trades when too much USDC is committed to positions</div>
            <div class="flex-row gap-8 mb-8">
              <label class="win-checkbox">
                <input type="checkbox" id="stopLossEnabled" onchange="updateStopLoss()">
                <span>Enable Stop-Loss</span>
              </label>
            </div>
            <div id="stopLossInputs" class="hidden">
              <div class="form-row">
                <label>Max commitment %:</label>
                <input type="number" id="stopLossPercent" value="80" min="1" max="99" class="win-input" style="width:80px;" onchange="updateStopLoss()">
              </div>
              <div class="form-hint">Stop new trades when this % of your USDC is in open positions</div>
            </div>
          </div>

          <!-- Monitoring Interval -->
          <div class="win-group">
            <div class="win-group-title">Monitoring Settings</div>
            <div class="form-row">
              <label>Scan Frequency (sec):</label>
              <input type="number" id="monitoringInterval" value="15" min="1" max="300" class="win-input" style="width:80px;" onchange="updateMonitoringInterval()">
            </div>
            <div class="form-hint">How often to check tracked wallets for new trades</div>
          </div>

          <!-- Security -->
          <div class="win-group">
            <div class="win-group-title">Security Configuration</div>
            <div class="win-warning mb-8">
              <strong>Warning:</strong> These credentials are stored in your .env file. Never share them.
            </div>
            <div class="form-row">
              <label>Private Key:</label>
              <input type="password" id="privateKey" placeholder="0x..." class="win-input">
              <button class="win-btn win-btn-sm" onclick="updatePrivateKey()">Update</button>
            </div>
            <div class="form-row">
              <label>Builder API Key:</label>
              <input type="text" id="builderApiKey" placeholder="Your API key" class="win-input">
            </div>
            <div class="form-row">
              <label>Builder Secret:</label>
              <input type="password" id="builderSecret" placeholder="Your secret" class="win-input">
            </div>
            <div class="form-row">
              <label>Builder Passphrase:</label>
              <input type="password" id="builderPassphrase" placeholder="Your passphrase" class="win-input">
              <button class="win-btn win-btn-sm" onclick="updateBuilderCredentials()">Update All</button>
            </div>
            <hr style="margin: 12px 0; border-color: var(--win-dark);">
            <div class="form-row">
              <label>Proxy Wallet:</label>
              <input type="text" id="proxyWalletAddress" placeholder="0x..." class="win-input text-mono">
              <button class="win-btn win-btn-sm" onclick="updateProxyWallet()">Update</button>
            </div>
            <div class="form-hint">Your Polymarket proxy wallet holds your USDC. Required for accurate balance display.</div>
          </div>
        </div>

        <!-- ============================================================
             DIAGNOSTICS TAB
             ============================================================ -->
        <div id="tab-diagnostics" class="win-tab-panel">
          <!-- CLOB Connectivity Test -->
          <div class="win-group">
            <div class="win-group-title">CLOB API Connectivity</div>
            <button class="win-btn win-btn-primary" onclick="testClobConnectivity()">Run Connectivity Test</button>
            <div id="clobTestResults" class="hidden" style="margin-top:8px;"></div>
          </div>

          <!-- Failed Trades Analysis -->
          <div class="win-group">
            <div class="win-group-title">Failed Trades Analysis</div>
            <div id="failedTradesAnalysis">
              <div class="text-center text-muted" style="padding:12px;">Click refresh to load failed trades analysis</div>
            </div>
            <button class="win-btn" onclick="loadFailedTrades()" style="margin-top:8px;">Refresh Analysis</button>
          </div>

          <!-- System Issues Log -->
          <div class="win-group">
            <div class="win-group-title">System Issues Log</div>
            <div id="systemIssuesLog">
              <div class="text-center text-muted" style="padding:12px;">No issues recorded</div>
            </div>
          </div>
        </div>

        <!-- ============================================================
             PLATFORMS TAB
             ============================================================ -->
        <div id="tab-platforms" class="win-tab-panel">
          <!-- Platform Status -->
          <div class="win-group">
            <div class="win-group-title">Platform Status</div>
            <div id="platformStatusGrid" class="platform-grid">
              <!-- Populated by JS -->
            </div>
          </div>

          <!-- Platform Balances -->
          <div class="win-group">
            <div class="win-group-title">Platform Balances</div>
            <div class="metrics-row" id="platformBalances">
              <div class="metric-box">
                <div class="metric-value" id="polymarketBalance">--</div>
                <div class="metric-label">Polymarket (USDC)</div>
              </div>
              <div class="metric-box">
                <div class="metric-value" id="kalshiBalance">--</div>
                <div class="metric-label">Kalshi (USD)</div>
              </div>
              <div class="metric-box">
                <div class="metric-value" id="totalCrossBalance">--</div>
                <div class="metric-label">Total</div>
              </div>
            </div>
          </div>

          <!-- Kalshi Configuration -->
          <div class="win-group">
            <div class="win-group-title">Kalshi API Configuration</div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">API Key ID</label>
                <input type="text" class="win-input" id="kalshiApiKeyId" placeholder="Enter Kalshi API Key ID">
              </div>
              <div class="form-group">
                <label class="form-label">Private Key (PEM)</label>
                <textarea class="win-input" id="kalshiPrivateKeyPem" rows="3" placeholder="Paste RSA private key PEM"></textarea>
              </div>
              <div class="form-group">
                <button class="win-btn win-btn-primary" onclick="saveKalshiConfig()">Save Kalshi Config</button>
                <button class="win-btn" onclick="testKalshiConnection()">Test Connection</button>
              </div>
            </div>
            <div id="kalshiTestResult" class="hidden" style="margin-top:8px;"></div>
          </div>

          <!-- Cross-Platform Entity Mapping -->
          <div class="win-group">
            <div class="win-group-title">Entity Wallet Mapping</div>
            <p class="form-hint">Link Polymarket wallets and Kalshi accounts to the same entity for cross-platform hedge detection.</p>
            <div id="entityPlatformMap">
              <!-- Populated by JS -->
              <div class="text-center text-muted" style="padding:12px;">Loading entities...</div>
            </div>
            <div style="margin-top: 8px;">
              <button class="win-btn" onclick="addPlatformWalletDialog()">+ Link Platform Wallet</button>
            </div>
          </div>
        </div>

        <!-- ============================================================
             CROSS-PLATFORM TAB
             ============================================================ -->
        <div id="tab-cross-platform" class="win-tab-panel">
          <!-- Executor Status -->
          <div class="win-group">
            <div class="win-group-title">Cross-Platform Executor</div>
            <div class="metrics-row" id="executorMetrics">
              <div class="metric-box">
                <div class="metric-value" id="execPaperMode">ON</div>
                <div class="metric-label">Paper Mode</div>
              </div>
              <div class="metric-box success">
                <div class="metric-value" id="execSuccessful">0</div>
                <div class="metric-label">Successful Arbs</div>
              </div>
              <div class="metric-box danger">
                <div class="metric-value" id="execPartialFills">0</div>
                <div class="metric-label">Partial Fills</div>
              </div>
              <div class="metric-box">
                <div class="metric-value" id="execTotal">0</div>
                <div class="metric-label">Total Executions</div>
              </div>
            </div>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
              <button class="win-btn win-btn-primary" onclick="toggleExecutorPaperMode()">Toggle Paper Mode</button>
              <button class="win-btn" onclick="refreshExecutorStatus()">Refresh</button>
            </div>
          </div>

          <!-- Arbitrage Opportunities -->
          <div class="win-group">
            <div class="win-group-title">Arbitrage Opportunities</div>
            <button class="win-btn" onclick="scanArbitrageOpportunities()" style="margin-bottom: 8px;">Scan Now</button>
            <div style="overflow-x: auto;">
              <table class="win-listview" id="arbTable">
                <thead>
                  <tr>
                    <th>Event</th>
                    <th>Poly Price</th>
                    <th>Kalshi Price</th>
                    <th>Spread</th>
                    <th>Expected Profit</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="arbTableBody">
                  <tr><td colspan="6" class="text-center text-muted">Click "Scan Now" to find opportunities</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Cross-Platform Hedges -->
          <div class="win-group">
            <div class="win-group-title">Cross-Platform Hedge Detection</div>
            <button class="win-btn" onclick="detectCrossPlatformHedges()" style="margin-bottom: 8px;">Detect Hedges</button>
            <div style="overflow-x: auto;">
              <table class="win-listview" id="crossHedgeTable">
                <thead>
                  <tr>
                    <th>Entity</th>
                    <th>Event</th>
                    <th>Poly Side/Size</th>
                    <th>Kalshi Side/Size</th>
                    <th>Hedged?</th>
                    <th>Net Exposure</th>
                  </tr>
                </thead>
                <tbody id="crossHedgeTableBody">
                  <tr><td colspan="6" class="text-center text-muted">Click "Detect Hedges" to scan</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Hedge Recommendations -->
          <div class="win-group">
            <div class="win-group-title">Hedge Recommendations</div>
            <button class="win-btn" onclick="generateHedgeRecommendations()" style="margin-bottom: 8px;">Generate Recommendations</button>
            <div id="hedgeRecommendations">
              <div class="text-center text-muted" style="padding:12px;">Generate recommendations to see actionable trades</div>
            </div>
          </div>

          <!-- Cross-Platform P&L -->
          <div class="win-group">
            <div class="win-group-title">Cross-Platform P&L</div>
            <div class="metrics-row" id="pnlMetrics">
              <div class="metric-box">
                <div class="metric-value" id="pnlTotalInvested">--</div>
                <div class="metric-label">Total Invested</div>
              </div>
              <div class="metric-box">
                <div class="metric-value" id="pnlCurrentValue">--</div>
                <div class="metric-label">Current Value</div>
              </div>
              <div class="metric-box success">
                <div class="metric-value" id="pnlUnrealized">--</div>
                <div class="metric-label">Unrealized P&L</div>
              </div>
              <div class="metric-box">
                <div class="metric-value" id="pnlPositions">--</div>
                <div class="metric-label">Positions</div>
              </div>
            </div>
            <div id="pnlPerPlatform" style="margin-top: 8px; font-size: 11px;"></div>
          </div>

          <!-- Execution History -->
          <div class="win-group">
            <div class="win-group-title">Execution History</div>
            <div style="overflow-x: auto;">
              <table class="win-listview" id="execHistoryTable">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Result</th>
                    <th>Buy</th>
                    <th>Sell</th>
                    <th>Paper?</th>
                  </tr>
                </thead>
                <tbody id="execHistoryTableBody">
                  <tr><td colspan="6" class="text-center text-muted">No executions yet</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Executor Configuration -->
          <div class="win-group">
            <div class="win-group-title">Executor Configuration</div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Max Trade Size (USD)</label>
                <input type="number" class="win-input" id="execMaxTradeSize" value="50">
              </div>
              <div class="form-group">
                <label class="form-label">Min Spread (%)</label>
                <input type="number" class="win-input" id="execMinSpread" value="2" step="0.5">
              </div>
              <div class="form-group">
                <label class="form-label">
                  <input type="checkbox" id="execSimultaneous" checked> Simultaneous Execution
                </label>
              </div>
              <div class="form-group">
                <button class="win-btn win-btn-primary" onclick="saveExecutorConfig()">Save Config</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Bar -->
      <div class="win-statusbar">
        <div class="win-statusbar-section" id="statusBarMain">Ready</div>
        <div class="win-statusbar-section fixed" id="statusBarPoly" title="Polymarket">POLY: --</div>
        <div class="win-statusbar-section fixed" id="statusBarKalshi" title="Kalshi">KALSHI: --</div>
        <div class="win-statusbar-section fixed" id="statusBarMode">Polling</div>
        <div class="win-statusbar-section fixed" id="statusBarBot">Stopped</div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       MIRROR POSITIONS MODAL
       ============================================================ -->
  <div id="mirrorModal" class="win-modal-overlay hidden">
    <div class="win-modal" style="max-width:800px;">
      <div class="win-titlebar">
        <div class="win-titlebar-icon">&#128196;</div>
        <div class="win-titlebar-text" id="mirrorModalTitle">Mirror Positions Preview</div>
        <div class="win-titlebar-buttons">
          <button class="win-titlebar-btn" onclick="closeMirrorModal()">X</button>
        </div>
      </div>
      <div class="win-modal-body" id="mirrorModalBody">
        <div class="mirror-summary-bar">
          <div class="mirror-summary-item">
            <div class="label">Your Portfolio:</div>
            <div class="value" id="mirrorYourPortfolio">$0.00</div>
          </div>
          <div class="mirror-summary-item">
            <div class="label">Your USDC:</div>
            <div class="value" id="mirrorYourUsdc">$0.00</div>
          </div>
          <div class="mirror-summary-item">
            <div class="label">Their Portfolio:</div>
            <div class="value" id="mirrorTheirPortfolio">$0.00</div>
          </div>
        </div>

        <div id="mirrorBalanceWarning" class="win-warning hidden">
          <span>&#9888;</span>
          <div>
            <strong>Insufficient Balance Warning</strong>
            <div id="mirrorWarningDetails"></div>
          </div>
        </div>

        <div class="mirror-trades-wrap">
          <table class="win-listview" id="mirrorTradesTable">
            <thead>
              <tr>
                <th style="width:30px;"></th>
                <th>Market</th>
                <th>Their Pos</th>
                <th>Your Pos</th>
                <th>Action</th>
                <th>Trade</th>
                <th>Price</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="mirrorTradesBody">
              <tr class="empty-row"><td colspan="8">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="execution-summary-bar" id="mirrorExecutionSummary">
          <span id="mirrorSummaryText">No trades selected</span>
        </div>
      </div>
      <div class="win-modal-footer">
        <button class="win-btn" onclick="closeMirrorModal()">Cancel</button>
        <button class="win-btn win-btn-primary" id="mirrorExecuteBtn" onclick="executeMirrorTrades()" disabled>Execute Selected</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       WALLET CONFIGURATION MODAL
       ============================================================ -->
  <div id="walletModal" class="win-modal-overlay hidden">
    <div class="win-modal">
      <div class="win-titlebar">
        <div class="win-titlebar-icon">&#9881;</div>
        <div class="win-titlebar-text" id="walletModalTitle">Configure Wallet</div>
        <div class="win-titlebar-buttons">
          <button class="win-titlebar-btn" onclick="closeWalletModal()">X</button>
        </div>
      </div>
      <div class="win-modal-body" id="walletModalBody">
        <!-- Wallet Info -->
        <div class="flex-row gap-8 mb-8">
          <span class="text-mono" id="modalWalletAddress">0x...</span>
          <span class="win-badge" id="modalWalletStatus">Inactive</span>
        </div>
        <div class="form-row mb-12">
          <label>Label:</label>
          <input type="text" id="modalWalletLabel" class="win-input" placeholder="e.g., WhaleTrader">
        </div>

        <div class="form-row mb-12">
          <label>Tags:</label>
          <div>
            <div id="modalTagButtons" class="flex-row gap-4 flex-wrap mb-4">
              <button type="button" class="tag-filter-btn" onclick="toggleModalTag('sports')" data-tag="sports" aria-label="Toggle sports tag" tabindex="0">sports</button>
              <button type="button" class="tag-filter-btn" onclick="toggleModalTag('politics')" data-tag="politics" aria-label="Toggle politics tag" tabindex="0">politics</button>
              <button type="button" class="tag-filter-btn" onclick="toggleModalTag('insider')" data-tag="insider" aria-label="Toggle insider tag" tabindex="0">insider</button>
              <button type="button" class="tag-filter-btn" onclick="toggleModalTag('crypto')" data-tag="crypto" aria-label="Toggle crypto tag" tabindex="0">crypto</button>
              <button type="button" class="tag-filter-btn" onclick="toggleModalTag('markets')" data-tag="markets" aria-label="Toggle markets tag" tabindex="0">markets</button>
            </div>
            <div class="flex-row gap-4">
              <input type="text" id="modalCustomTag" class="win-input" placeholder="Custom tag..." style="width:140px;" aria-label="Custom tag name">
              <button type="button" class="win-btn win-btn-sm" onclick="addCustomModalTag()" aria-label="Add custom tag" tabindex="0">Add</button>
            </div>
            <input type="hidden" id="modalWalletTags" value="">
          </div>
        </div>

        <!-- Trade Size -->
        <div class="win-group">
          <div class="win-group-title">Trade Size [Required]</div>
          <div class="text-sm text-muted mb-8">How much USDC to use when copying trades from this wallet</div>
          <div class="flex-row gap-8">
            <span>$</span>
            <input type="number" id="modalTradeSize" class="win-input" value="2" min="0.01" step="0.01" style="width:120px;">
            <span>USDC</span>
          </div>
        </div>

        <!-- Trade Sizing Mode -->
        <div class="win-group">
          <div class="win-group-title">Trade Sizing Mode</div>
          <label class="win-radio">
            <input type="radio" name="modalTradeSizingMode" value="fixed" checked>
            <span>Fixed size (use the trade size above for every trade)</span>
          </label>
          <label class="win-radio">
            <input type="radio" name="modalTradeSizingMode" value="proportional">
            <span>Proportional (match their portfolio %)</span>
          </label>
          <div style="margin-top:8px;">
            <label class="win-checkbox">
              <input type="checkbox" id="modalThresholdEnabled">
              <span>Enable threshold filter (only copy trades &gt; X% of their portfolio)</span>
            </label>
            <div id="modalThresholdInputs" class="hidden" style="margin-left:24px;margin-top:4px;">
              <div class="form-row">
                <label>Threshold %:</label>
                <input type="number" id="modalThresholdPercent" class="win-input" value="10" min="0.1" max="100" step="0.1" style="width:80px;">
              </div>
            </div>
          </div>
        </div>

        <!-- Trade Side Filter -->
        <div class="win-group">
          <div class="win-group-title">Trade Side Filter</div>
          <div class="flex-row gap-16 flex-wrap">
            <label class="win-radio">
              <input type="radio" name="modalTradeSideFilter" value="all" checked>
              <span>All trades</span>
            </label>
            <label class="win-radio">
              <input type="radio" name="modalTradeSideFilter" value="buy_only">
              <span>BUY only</span>
            </label>
            <label class="win-radio">
              <input type="radio" name="modalTradeSideFilter" value="sell_only">
              <span>SELL only</span>
            </label>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="win-group">
          <div class="win-group-title">Advanced Filters</div>

          <!-- No Repeat -->
          <div class="filter-block">
            <div class="filter-header">
              <span>No Repeat Trades</span>
              <label class="win-toggle"><input type="checkbox" id="modalNoRepeatEnabled"></label>
            </div>
            <div class="filter-hint">Block repeat trades in the same market+side</div>
            <div id="modalNoRepeatInputs" class="hidden">
              <div class="form-row">
                <label>Block period:</label>
                <select id="modalNoRepeatPeriod" class="win-select">
                  <option value="0">Forever (until cleared)</option>
                  <option value="1">1 hour</option>
                  <option value="6">6 hours</option>
                  <option value="12">12 hours</option>
                  <option value="24" selected>24 hours</option>
                  <option value="48">48 hours</option>
                  <option value="168">7 days</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Price Limits -->
          <div class="filter-block">
            <div class="filter-header">
              <span>Price Limits</span>
              <span class="win-badge" id="modalPriceBadge">DEFAULT</span>
            </div>
            <div class="filter-hint">Only copy trades within this price range</div>
            <div class="flex-row gap-8">
              <label>Min:</label>
              <input type="number" id="modalPriceLimitsMin" class="win-input" value="0.01" min="0.01" max="0.98" step="0.01" style="width:80px;">
              <label>Max:</label>
              <input type="number" id="modalPriceLimitsMax" class="win-input" value="0.99" min="0.02" max="0.99" step="0.01" style="width:80px;">
            </div>
          </div>

          <!-- Trade Value Filter -->
          <div class="filter-block">
            <div class="filter-header">
              <span>Trade Value Filter</span>
              <label class="win-toggle"><input type="checkbox" id="modalValueFilterEnabled"></label>
            </div>
            <div class="filter-hint">Filter by the detected trade value (their trade size)</div>
            <div id="modalValueFilterInputs" class="hidden">
              <div class="flex-row gap-8">
                <label>Min ($):</label>
                <input type="number" id="modalValueFilterMin" class="win-input" placeholder="No min" min="0" style="width:80px;">
                <label>Max ($):</label>
                <input type="number" id="modalValueFilterMax" class="win-input" placeholder="No max" min="0" style="width:80px;">
              </div>
            </div>
          </div>

          <!-- Rate Limiting -->
          <div class="filter-block">
            <div class="filter-header">
              <span>Rate Limiting</span>
              <label class="win-toggle"><input type="checkbox" id="modalRateLimitEnabled"></label>
            </div>
            <div class="filter-hint">Limit trades copied from this wallet</div>
            <div id="modalRateLimitInputs" class="hidden">
              <div class="flex-row gap-8">
                <label>Max/hour:</label>
                <input type="number" id="modalRateLimitPerHour" class="win-input" value="10" min="1" max="100" style="width:80px;">
                <label>Max/day:</label>
                <input type="number" id="modalRateLimitPerDay" class="win-input" value="50" min="1" max="500" style="width:80px;">
              </div>
            </div>
          </div>

          <!-- Slippage -->
          <div class="filter-block">
            <div class="filter-header">
              <span>Slippage</span>
              <span class="win-badge" id="modalSlippageBadge">DEFAULT (2%)</span>
            </div>
            <div class="filter-hint">Adjust order price for immediate fills</div>
            <div class="form-row">
              <label>Slippage %:</label>
              <input type="number" id="modalSlippagePercent" class="win-input" placeholder="2" min="0.5" max="10" step="0.5" style="width:80px;">
            </div>
          </div>
        </div>

        <!-- Pipeline Preview -->
        <div class="win-group">
          <div class="win-group-title">Trade Filter Pipeline</div>
          <div class="text-sm text-muted mb-8">Trades from this wallet pass through these filters in order:</div>
          <div class="pipeline-preview" id="modalPipelinePreview">
            <div class="pipeline-step">
              <div class="step-icon">1</div>
              <div class="step-content">
                <div class="step-title">Wallet Active</div>
                <div class="step-desc">Check wallet is enabled</div>
              </div>
              <div class="step-status always-on">Always</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step" id="modal-pipeline-side">
              <div class="step-icon">2</div>
              <div class="step-content">
                <div class="step-title">Side Filter</div>
                <div class="step-desc" id="modal-pipeline-side-desc">All trades</div>
              </div>
              <div class="step-status off" id="modal-pipeline-side-status">OFF</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step" id="modal-pipeline-price">
              <div class="step-icon">3</div>
              <div class="step-content">
                <div class="step-title">Price Limits</div>
                <div class="step-desc" id="modal-pipeline-price-desc">$0.01 - $0.99</div>
              </div>
              <div class="step-status off" id="modal-pipeline-price-status">DEFAULT</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step" id="modal-pipeline-norepeat">
              <div class="step-icon">4</div>
              <div class="step-content">
                <div class="step-title">No Repeat</div>
                <div class="step-desc" id="modal-pipeline-norepeat-desc">Disabled</div>
              </div>
              <div class="step-status off" id="modal-pipeline-norepeat-status">OFF</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step" id="modal-pipeline-value">
              <div class="step-icon">5</div>
              <div class="step-content">
                <div class="step-title">Value Filter</div>
                <div class="step-desc" id="modal-pipeline-value-desc">No limits</div>
              </div>
              <div class="step-status off" id="modal-pipeline-value-status">OFF</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step" id="modal-pipeline-rate">
              <div class="step-icon">6</div>
              <div class="step-content">
                <div class="step-title">Rate Limit</div>
                <div class="step-desc" id="modal-pipeline-rate-desc">Unlimited</div>
              </div>
              <div class="step-status off" id="modal-pipeline-rate-status">OFF</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step">
              <div class="step-icon">7</div>
              <div class="step-content">
                <div class="step-title">Apply Size</div>
                <div class="step-desc" id="modal-pipeline-size-desc">$2 USDC</div>
              </div>
              <div class="step-status always-on">Always</div>
            </div>
            <div class="pipeline-arrow">|</div>
            <div class="pipeline-step final">
              <div class="step-icon">&#10003;</div>
              <div class="step-content">
                <div class="step-title">Execute Trade</div>
                <div class="step-desc">Place order on CLOB</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="win-modal-footer">
        <button class="win-btn" onclick="closeWalletModal()">Discard</button>
        <button class="win-btn" id="modalSaveBtn" onclick="saveWalletConfig()">Save Draft</button>
        <button class="win-btn win-btn-primary win-btn-success" id="modalSaveEnableBtn" onclick="saveWalletConfigAndEnable()">Save &amp; Enable</button>
      </div>
    </div>
  </div>

  <!-- Builder Credentials Modal -->
  <div id="builderCredsModal" class="win-modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="builderCredsModalTitle">
    <div class="win-modal" style="max-width:480px;">
      <div class="win-titlebar">
        <div class="win-titlebar-icon">&#128273;</div>
        <div class="win-titlebar-text" id="builderCredsModalTitle">Add Builder API Credentials</div>
        <div class="win-titlebar-buttons">
          <button class="win-titlebar-btn" onclick="closeBuilderCredsModal()" aria-label="Close" tabindex="0">&#10005;</button>
        </div>
      </div>
      <div class="win-modal-body">
        <div class="win-info mb-8">
          <span>&#9432;</span>
          <span>These credentials are required to place orders on Polymarket. Get them from
            <a href="https://polymarket.com/settings?tab=builder" target="_blank" rel="noopener noreferrer" style="color:var(--win-blue);font-weight:bold;">polymarket.com/settings &rarr; Builder tab</a>
          </span>
        </div>
        <div class="text-sm mb-8">Wallet: <strong id="builderCredsWalletLabel"></strong></div>
        <input type="hidden" id="builderCredsWalletId">

        <div class="form-row">
          <label for="builderCredsApiKey">API Key:</label>
          <div style="flex:1;display:flex;gap:4px;max-width:260px;">
            <input type="password" id="builderCredsApiKey" placeholder="Enter API key" class="win-input" style="flex:1;" aria-label="Builder API Key" autocomplete="off">
            <button class="win-btn win-btn-sm" type="button" onclick="toggleCredFieldVisibility('builderCredsApiKey', this)" aria-label="Show/hide API key" tabindex="0" style="min-width:40px;">Show</button>
          </div>
        </div>
        <div class="form-row">
          <label for="builderCredsApiSecret">API Secret:</label>
          <div style="flex:1;display:flex;gap:4px;max-width:260px;">
            <input type="password" id="builderCredsApiSecret" placeholder="Enter API secret" class="win-input" style="flex:1;" aria-label="Builder API Secret" autocomplete="off">
            <button class="win-btn win-btn-sm" type="button" onclick="toggleCredFieldVisibility('builderCredsApiSecret', this)" aria-label="Show/hide API secret" tabindex="0" style="min-width:40px;">Show</button>
          </div>
        </div>
        <div class="form-row">
          <label for="builderCredsPassphrase">Passphrase:</label>
          <div style="flex:1;display:flex;gap:4px;max-width:260px;">
            <input type="password" id="builderCredsPassphrase" placeholder="Enter passphrase" class="win-input" style="flex:1;" aria-label="Builder API Passphrase" autocomplete="off">
            <button class="win-btn win-btn-sm" type="button" onclick="toggleCredFieldVisibility('builderCredsPassphrase', this)" aria-label="Show/hide passphrase" tabindex="0" style="min-width:40px;">Show</button>
          </div>
        </div>

        <div id="builderCredsError" class="win-error hidden" style="margin-top:8px;">
          <span>&#9888;</span>
          <span id="builderCredsErrorText"></span>
        </div>
      </div>
      <div class="win-modal-footer">
        <button class="win-btn" onclick="closeBuilderCredsModal()" tabindex="0">Cancel</button>
        <button class="win-btn win-btn-primary" onclick="submitBuilderCredentials()" tabindex="0">Save Credentials</button>
      </div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <button class="start-btn" id="startStopBtn" onclick="toggleBot()">
      <div class="start-logo"></div>
      <span id="startStopLabel">Start</span>
    </button>
    <div class="taskbar-divider"></div>
    <div class="taskbar-items">
      <div class="taskbar-item active">CopyTrade95</div>
    </div>
    <div class="taskbar-status">
      <div class="status-indicator stopped" id="taskbarIndicator"></div>
      <span id="taskbarStatus">Stopped</span>
    </div>
    <div class="taskbar-divider"></div>
    <div class="taskbar-clock" id="taskbarClock">--:--</div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
